# Nano MQTT ethernet switch
Проект четырехканального, управляемого через MQTT реле, подключаемого через Ethernet.  
Собирается на базе [Arduino nano](https://www.aliexpress.com/wholesale?SearchText=Arduino+nano) и [Mini ENC28J60 Ethernet Shield](https://www.aliexpress.com/wholesale?SearchText=Mini+ENC28J60+Ethernet+Shield).

### Распиновка
Порты можно менять в файле `settings.h`. Входы активируются подтягиванием к земле. На выходах в активном состоянии +5v.  

| Порт | Направление | Назначение |
| :--- | :---------- | :--------- |
| `D7` | Выход | Реле 1 |
| `D6` | Выход | Реле 2 |
| `D5` | Выход | Реле 3 |
| `D4` | Выход | Реле 4 |
| `D3` | Выход | Статус подключения к MQTT серверу |
| `A1` | Вход | Кнопка управления реле 1 |
| `A2` | Вход | Кнопка управления реле 2 |
| `A3` | Вход | Кнопка управления реле 3 |
| `A4` | Вход | Кнопка управления реле 4 |

### Управление
Настройка устройства производится через консоль, в которую можно попасть через COM порт (скорость 9600), при подключении устройства по USB, или через TELNET сервер на 23 порту, при подключении через сеть.  

#### Список команд
 - `?`  
Выводит список доступных комманд
 - `ip [-D <enable|disable>] [-i <ipv4 address>] [-s <subnet mask>] [-g <gateway ip>]`  
Настройки сети.  
`-D <enable|disable>` - включить или выключить получение ip по DHCP;  
`-i <ipv4 address>` - ip адрес устройства;  
`-s <subnet mask>` - маска подсети;  
`-g <gateway ip>` - ip адрес шлюза.  
 - `mqtt [-s <ipv4 address>] [-p <port>] [-t <topic prefix>]`  
 Настройка подключения к MQTT серверу.  
 `-s <ipv4 address>` - ip адрес MQTT сервера;  
 `-p <port>` - порт MQTT сервера;  
 `-t <topic prefix>` - префикс топика MQTT.  
 - `status [<1|2|3|4> <ON|OFF|TOGGLE>]`  
Управление состоянием реле. Первый параметр - номер реле, второй - команда ON, OFF или TOGGLE.  
 - `reboot`  
Перезагрузка устройства. Для применения новых настроек.  

### MQTT топики
Реле управляется через MQTT сервер.  
Список доступных топиков:  

| Топик | Направление | Нагрузка | Назначение |
| :---- | :---------- | :------- | :--------- |
| `<topic prefix>/relay1/set` | Запись | `ON`, `OFF`, `TOGGLE` | Установка состояние реле 1 |
| `<topic prefix>/relay2/set` | Запись | `ON`, `OFF`, `TOGGLE` | Установка состояние реле 2 |
| `<topic prefix>/relay3/set` | Запись | `ON`, `OFF`, `TOGGLE` | Установка состояние реле 3 |
| `<topic prefix>/relay4/set` | Запись | `ON`, `OFF`, `TOGGLE` | Установка состояние реле 4 |
| `<topic prefix>/relay1/stat` | Чтение | `ON`, `OFF` | Получение состояния реле 1 |
| `<topic prefix>/relay2/stat` | Чтение | `ON`, `OFF` | Получение состояния реле 2 |
| `<topic prefix>/relay3/stat` | Чтение | `ON`, `OFF` | Получение состояния реле 3 |
| `<topic prefix>/relay4/stat` | Чтение | `ON`, `OFF` | Получение состояния реле 4 |
| `<topic prefix>/LWT` | Чтение | `offline`, `online` | Получение доступности устройства |

#### Прошивка
Из за того, что драйвер Ethernet занимает большую часть памяти, прошивку удалось уместить в микроконтроллер только избавившись от загрузчика, поэтому для прошивки требуется внешний программатор, подключаемый через ISP разъем.  

#### Зависимости:  
 - Менеджер плат [Bare ATmega 8/168/328](https://github.com/carlosefr/atmega)
 - [Arduino command line tool](https://github.com/arduino/arduino-cli)

#### Сборка
`make build`

#### Прошивка
`make upload`  
Программатор и порт программатора настраивается в файле `Makefile`
